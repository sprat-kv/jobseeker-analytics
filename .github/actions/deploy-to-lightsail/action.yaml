name: Deploy to AWS Lightsail
description: Deploy application to a specific environment

inputs:
  aws-access-key-id:
    description: AWS Access Key ID
    required: true
  aws-region:
    description: AWS Region
    required: true
  aws-secret-access-key:
    description: AWS Access Key Secret
    required: true
  google-credentials-file-content:
    description: Google Credentials File Content
    required: true
  ls-database-name:
    description: Lightsail Database Name
    required: true
  redirect-uri:
    description: Login redirect URI associated with the Google App
    required: true
  cookie-secret:
    description: Cookie secret
    required: true
  google-api-key:
    description: Google API Key
    required: true

runs:
  using: composite
  steps:
  - name: Mask sensitive inputs
    shell: bash
    run: |
      echo "::add-mask::${{ inputs.aws-access-key-id }}"
      echo "::add-mask::${{ inputs.aws-secret-access-key }}"
      echo "::add-mask::${{ inputs.google-credentials-file-content }}"
      echo "::add-mask::${{ inputs.cookie-secret }}"
      echo "::add-mask::${{ inputs.google-api-key }}"
      echo "::add-mask::${{ inputs.redirect-uri }}"
      echo "::add-mask::${{ inputs.ls-database-name }}"

  - name: Set up AWS CLI
    uses: aws-actions/configure-aws-credentials@v1
    with:
      aws-access-key-id: ${{ inputs.aws-access-key-id }}
      aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
      aws-region: ${{ inputs.aws-region }}

  - name: Install Lightsail plugin
    shell: bash
    run: |
      curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "/usr/local/bin/lightsailctl"
      chmod +x /usr/local/bin/lightsailctl

  - name: Query database connection info from Lightsail
    id: get_db_info
    env:
      LS_DATABASE_NAME: ${{ inputs.ls-database-name }}
    shell: bash
    run: |
      # Query the master password from Lightsail database
      MASTER_PASSWORD=$(aws lightsail get-relational-database-master-user-password \
        --relational-database-name ${LS_DATABASE_NAME} \
        --password-version CURRENT \
        --query 'masterUserPassword' \
        --output text)

      # Mask the master password
      echo "::add-mask::${MASTER_PASSWORD}"

      # Query database details for connection info
      DB_INFO=$(aws lightsail get-relational-database \
        --relational-database-name ${LS_DATABASE_NAME})

      # Extract connection details
      MASTER_USERNAME=$(echo $DB_INFO | jq -r '.relationalDatabase.masterUsername')
      MASTER_DATABASE_NAME=$(echo $DB_INFO | jq -r '.relationalDatabase.masterDatabaseName')
      ENDPOINT_ADDRESS=$(echo $DB_INFO | jq -r '.relationalDatabase.masterEndpoint.address')
      ENDPOINT_PORT=$(echo $DB_INFO | jq -r '.relationalDatabase.masterEndpoint.port')

      # Mask sensitive DB info
      echo "::add-mask::${MASTER_USERNAME}"
      echo "::add-mask::${MASTER_DATABASE_NAME}"
      echo "::add-mask::${ENDPOINT_ADDRESS}"
      echo "::add-mask::${ENDPOINT_PORT}"

      # Set as outputs for use in subsequent steps
      echo "database_url=postgresql://${MASTER_USERNAME}:${MASTER_PASSWORD}@${ENDPOINT_ADDRESS}:${ENDPOINT_PORT}/${MASTER_DATABASE_NAME}" >> $GITHUB_OUTPUT

  - name: Mask database URL
    run: echo "::add-mask::${{ steps.get_db_info.outputs.database_url }}"

  - name: Stage Google credentials.json
    shell: bash
    run: |
      cat << 'EOF' > backend/credentials.json
      ${{ inputs.google-credentials-file-content }}
      EOF

  - name: Build and push Docker image
    env:
      LIGHTSAIL_SERVICE_NAME: jaja-backend
      CONTAINER_NAME: backend
    shell: bash
    run: |
      # Build Docker image
      docker build -t ${LIGHTSAIL_SERVICE_NAME}-${CONTAINER_NAME}:${{ github.sha }} --platform=linux/amd64 ./backend

      # Push to Lightsail
      aws lightsail push-container-image \
        --service-name ${LIGHTSAIL_SERVICE_NAME} \
        --label ${CONTAINER_NAME} \
        --image ${LIGHTSAIL_SERVICE_NAME}-${CONTAINER_NAME}:${{ github.sha }}

  - name: Deploy to Lightsail
    env:
      CONTAINER_PORT: 8000
      PUBLIC_PORT: 80
      DATABASE_URL: ${{ steps.get_db_info.outputs.database_url }}
      REDIRECT_URI: ${{ inputs.redirect-uri }}
      COOKIE_SECRET: ${{ inputs.cookie-secret }}
      GOOGLE_API_KEY: ${{ inputs.google-api-key }}
      GOOGLE_CLIENT_SECRETS_JSON: ${{ inputs.google-credentials-file-content }}
    shell: bash
    run: |
      # Mask env vars before use
      echo "::add-mask::${COOKIE_SECRET}"
      echo "::add-mask::${GOOGLE_API_KEY}"
      echo "::add-mask::${GOOGLE_CLIENT_SECRETS_JSON}"
      echo "::add-mask::${DATABASE_URL}"
      echo "::add-mask::${REDIRECT_URI}"

      # Create deployment JSON
      cat > lc.json << EOF
      {
        "serviceName": "${LIGHTSAIL_SERVICE_NAME}",
        "containers": {
          "${CONTAINER_NAME}": {
            "image": ":${LIGHTSAIL_SERVICE_NAME}.${CONTAINER_NAME}.latest",
            "environment": {
              "REDIRECT_URI": "${REDIRECT_URI}",
              "GOOGLE_API_KEY": "${GOOGLE_API_KEY}",
              "COOKIE_SECRET": "${COOKIE_SECRET}",
              "APP_URL": "http://localhost:3000",
              "ENV": "staging",
              "DATABASE_URL": "${DATABASE_URL}",
              "GOOGLE_CLIENT_SECRETS_JSON": "${GOOGLE_CLIENT_SECRETS_JSON}"
            },
            "ports": {
              "${CONTAINER_PORT}": "HTTP"
            }
          }
        },
        "publicEndpoint": {
          "containerName": "${CONTAINER_NAME}",
          "containerPort": ${CONTAINER_PORT},
          "healthCheck": {
            "healthyThreshold": 2,
            "unhealthyThreshold": 2,
            "timeoutSeconds": 5,
            "intervalSeconds": 10,
            "path": "/",
            "successCodes": "200-499"
          }
        }
      }
      EOF

      # Deploy to Lightsail
      aws lightsail create-container-service-deployment \
        --cli-input-json file://lc.json
